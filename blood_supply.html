<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Supply Checker</title>
</head>
<body>
    <h1>Blood Supply Checker</h1>

    <div>
        <label for="abo-group">ABO Blood Group</label>
        <!-- Note to self: ABO Group does NOT need values for now, needs to say uppercase. -->
        <select id="abo-group">
            <option>A</option>
            <option>B</option>
            <option>AB</option>
            <option>O</option>
        </select>
    </div>

    <div>
        <label for="rh-group">Rh Group</label>
        <select id="rh-group">
            <!-- value is needed because url needs lowercase, also converts better to other languages -->
            <option value="positive">Positive</option>
            <option value="negative">Negative</option>
        </select>
    </div>
    
    <div>
        <button id="request-blood-button">Check blood supply</button>
    </div>

    <div>
        <p id="results"></p>
    </div>

<script>
    // When the button is clicked
    // 1. Read user's selections for ABO and Rh types
    // 2. Form the correct URL string
    // 3. Make a request
    // 4. Process the resounse - either display data to user OR display error message

    // Connects back to elements in html body
    let requestBloodSupplyButton = document.querySelector('#request-blood-button')
    let aboSelect = document.querySelector('#abo-group')
    let rhSelect = document.querySelector('#rh-group')

    let resultMessageElement = document.querySelector('#results')

    // Event listener for Blood Supply Check button
    requestBloodSupplyButton.addEventListener('click', function() {
        // Read data from select elements
        let aboGroup = aboSelect.value
        let rhGroup = rhSelect.value

        let url = 'https://blood-group-api.wl.r.appspot.com/api/blood_units_by_group?group=' + aboGroup + rhGroup
        
        //console.log(url) // for checking everything thus far is working the way we want it to.

        // What does fetch return? A Promise.
        // Promises can be fulfilled or resolved - the operation was completed. Then we can process that data.
        // Or they can be rejected - there was an error. 
        // We have to catch the error (the error is 'thrown').
        fetch(url).then(function(response) {
            // 'response' is the whole response from the server.
            // Which hopefully includes JSON data.
            // The function here is called when data is available
            // from the server. The then function calls
            // the callback function with all the data from the 
            // server as the argument.

            // What about the JSON?? use .json() to extract - returns a promise
            // Extract json then process it.
            let jsonPromise = response.json()
                return jsonPromise //Where does this go?
            // If I return a promise from a then callback function
            // the resolution from that promise can be used in a chained on 'then'
        }).then(function(jsonData) {
            //console.log(jsonData)
            // Connects to the specific data we need.
            let unitsAvailable = jsonData.blood_availability.units_available
            //console.log(unitsAvailable)
            // Template for message results to go into p element in html
            resultMessageElement.innerHTML = 'There are ' + unitsAvailable + ' units available of blood type ' + aboGroup + ' ' + rhGroup + '.'
        }).catch( error => {
            // Error message for p element in html in case something goes wrong.
            resultMessageElement.innerHTML = 'Sorry, there was an error fetching the blood supply data.'
        })
        


    })

</script>
</body> 
</html>